<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prize Counter - Arcade Hub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='global.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='shop.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div class="user-menu">
        <div class="user-profile-btn" style="cursor: default;"> 
            <div class="avatar-display">
                {% if user.avatar.startswith('http') %}
                    <img src="{{ user.avatar }}">
                {% elif user.avatar == 'default.png' %}
                    <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=0f172a&color=fff">
                {% else %}
                    <img src="{{ url_for('static', filename='uploads/' + user.avatar) }}">
                {% endif %}
            </div>
            <span class="username-display">{{ user.username }}</span>
        </div>
    </div>

    <div class="shop-header">
        <h1>üéÅ PRIZE COUNTER</h1>
        <div class="balance-card">
            <div class="label">YOUR TICKETS</div>
            <div class="amount" id="balanceDisplay">üéüÔ∏è {{ wallet.balance }}</div>
            <div class="sub-text">Total Earned: {{ wallet.total_earned }}</div>
        </div>
    </div>

    <div class="shop-container">
        
        <h2 class="section-title"><i class="fa-solid fa-tag"></i> TITLES</h2>
        <div class="items-grid">
            {% for key, item in items.items() if item.type == 'title' %}
            <div class="shop-item">
                <div class="item-preview title-preview">{{ item.value }}</div>
                <div class="item-info">
                    <div class="item-name">{{ item.name }}</div>
                    <div class="item-price">üéüÔ∏è {{ item.price }}</div>
                </div>
                
                <div class="action-area">
                    {% if key in owned %}
                        {% if user.equipped_title == item.value %}
                            <button class="btn-equipped" disabled>EQUIPPED</button>
                        {% else %}
                            <button class="btn-equip" onclick="equipItem('{{ key }}')">EQUIP</button>
                        {% endif %}
                    {% else %}
                        <button class="btn-buy" onclick="buyItem('{{ key }}', {{ item.price }})" {% if wallet.balance < item.price %}disabled{% endif %}>
                            BUY
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            <div class="shop-item" style="border-style: dashed; opacity: 0.7;">
                <div class="item-preview title-preview" style="color: #666;">(None)</div>
                <div class="item-info">
                    <div class="item-name">No Title</div>
                    <div class="item-price">FREE</div>
                </div>
                <div class="action-area">
                    <button class="btn-equip" onclick="equipItem('unequip_title')">UNEQUIP</button>
                </div>
            </div>
        </div>

        <div style="margin: 40px 0; border-top: 1px solid rgba(255,255,255,0.1);"></div>

        <h2 class="section-title"><i class="fa-solid fa-user-astronaut"></i> AVATARS</h2>
        <div class="items-grid">
            {% for key, item in items.items() if item.type == 'avatar' %}
            <div class="shop-item">
                <div class="item-preview avatar-preview">
                    <img src="{{ item.value }}">
                </div>
                <div class="item-info">
                    <div class="item-name">{{ item.name }}</div>
                    <div class="item-price">üéüÔ∏è {{ item.price }}</div>
                </div>
                
                <div class="action-area">
                    {% if key in owned %}
                        {% if user.avatar == item.value %}
                            <button class="btn-equipped" disabled>EQUIPPED</button>
                        {% else %}
                            <button class="btn-equip" onclick="equipItem('{{ key }}')">EQUIP</button>
                        {% endif %}
                    {% else %}
                        <button class="btn-buy" onclick="buyItem('{{ key }}', {{ item.price }})" {% if wallet.balance < item.price %}disabled{% endif %}>
                            BUY
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div style="text-align: center; margin-top: 50px;">
            <a href="/lobby" class="btn-secondary" style="border-radius: 50px; padding: 10px 30px; text-decoration: none;">
                ‚Üê Back to Lobby
            </a>
        </div>
    </div>

    <script>
        function buyItem(itemId, price) {
            if(!confirm(`Spend ${price} Tickets to buy this item?`)) return;

            fetch('/api/buy', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ item_id: itemId })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    alert("Purchase Successful!");
                    location.reload();
                } else {
                    alert("Error: " + data.message);
                }
            });
        }

        function equipItem(itemId) {
            fetch('/api/equip', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ item_id: itemId })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    location.reload();
                } else {
                    alert("Error: " + data.message);
                }
            });
        }
    </script>
</body>
</html>